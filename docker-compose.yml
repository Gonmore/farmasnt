services:
  backend-farmasnt:
    # Sustituimos 'build' por la imagen de tu registro
    image: gonmore14/backend-farmasnt:${APP_VERSION:-latest}
    container_name: backend-farmasnt
    restart: always
    environment:
      DATABASE_URL: ${DATABASE_URL:?set DATABASE_URL in .env}
      PORT: ${PORT:-6000}
      NODE_ENV: production
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET:?set JWT_ACCESS_SECRET in .env}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?set JWT_REFRESH_SECRET in .env}
      RUN_SEED: ${RUN_SEED:-0}
      SEED_TENANT_NAME: ${SEED_TENANT_NAME:-Demo Pharma}
      SEED_ADMIN_EMAIL: ${SEED_ADMIN_EMAIL:-admin@demo.local}
      SEED_ADMIN_PASSWORD: ${SEED_ADMIN_PASSWORD:-}
      SEED_PLATFORM_DOMAIN: ${SEED_PLATFORM_DOMAIN:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-465}
      SMTP_SECURE: ${SMTP_SECURE:-true}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      WEB_ORIGIN: ${WEB_ORIGIN:?set WEB_ORIGIN in .env}
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      PRISMA_MIGRATE_RESOLVE_ON_FAIL: ${PRISMA_MIGRATE_RESOLVE_ON_FAIL:-1}
      PRISMA_MIGRATE_RESOLVE_ACTION: ${PRISMA_MIGRATE_RESOLVE_ACTION:-rolled-back}
      PRISMA_MIGRATE_RESOLVE_NAMES: ${PRISMA_MIGRATE_RESOLVE_NAMES:-20260116063727_pagos}
    ports:
      - "6000:6000"
    networks:
      - red-interna

  backend-seed:
    image: gonmore14/backend-farmasnt:${APP_VERSION:-latest}
    container_name: backend-farmasnt-seed
    restart: "no"
    environment:
      DATABASE_URL: ${DATABASE_URL:?set DATABASE_URL in .env}
      NODE_ENV: production
      SEED_TENANT_NAME: ${SEED_TENANT_NAME:-Demo Pharma}
      SEED_ADMIN_EMAIL: ${SEED_ADMIN_EMAIL:-admin@demo.local}
      SEED_ADMIN_PASSWORD: ${SEED_ADMIN_PASSWORD:-}
      SEED_PLATFORM_DOMAIN: ${SEED_PLATFORM_DOMAIN:-}
      PRISMA_MIGRATE_RESOLVE_ON_FAIL: ${PRISMA_MIGRATE_RESOLVE_ON_FAIL:-1}
      PRISMA_MIGRATE_RESOLVE_ACTION: ${PRISMA_MIGRATE_RESOLVE_ACTION:-rolled-back}
      PRISMA_MIGRATE_RESOLVE_NAMES: ${PRISMA_MIGRATE_RESOLVE_NAMES:-20260116063727_pagos}
    command: ["sh", "-lc", "npm run seed"]
    networks:
      - red-interna
    profiles: ["tools"]

  backend-migrate:
    image: gonmore14/backend-farmasnt:${APP_VERSION:-latest}
    container_name: backend-farmasnt-migrate
    restart: "no"
    environment:
      DATABASE_URL: ${DATABASE_URL:?set DATABASE_URL in .env}
      NODE_ENV: production
      PRISMA_MIGRATE_RESOLVE_ON_FAIL: ${PRISMA_MIGRATE_RESOLVE_ON_FAIL:-1}
      PRISMA_MIGRATE_RESOLVE_ACTION: ${PRISMA_MIGRATE_RESOLVE_ACTION:-rolled-back}
      PRISMA_MIGRATE_RESOLVE_NAMES: ${PRISMA_MIGRATE_RESOLVE_NAMES:-20260116063727_pagos}
    command: ["sh", "-lc", "npm run prisma:migrate"]
    networks:
      - red-interna
    profiles: ["tools"]

  frontend-farmasnt:
    # Sustituimos 'build' por la imagen de tu registro
    image: gonmore14/frontend-farmasnt:${APP_VERSION:-latest}
    container_name: frontend-farmasnt
    restart: always
    environment:
      VITE_ALLOW_ALL_HOSTS: "1"
    depends_on:
      - backend-farmasnt
    ports:
      - "6001:6001"
    networks:
      - red-interna

networks:
  red-interna:
    name: red-interna
    external: true