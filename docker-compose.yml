services:
  backend-farmasnt:
    build:
      context: ./backend
    container_name: backend-farmasnt
    restart: always
    environment:
      # Formato LLAVE: VALOR (Nota el uso de : y sin comillas innecesarias a menos que haya caracteres raros)
      DATABASE_URL: "postgresql://postgres:D3v3%2Fop3R@postgres-principal:5432/farmasnt?schema=public"
      PORT: 6000
      NODE_ENV: "production"
      JWT_ACCESS_SECRET: "Supern0vat0s2026"
      JWT_REFRESH_SECRET: "Supern0vat0s2026"
      # RUN_SEED=1 ejecuta `npm run seed` al arrancar (idempotente)
      RUN_SEED: "0"
      SEED_TENANT_NAME: "Demo Pharma"
      SEED_ADMIN_EMAIL: "admin@demo.local"
      SEED_ADMIN_PASSWORD: "Admin123!"
      SEED_PLATFORM_DOMAIN: "farmasnt.supernovatel.com"
      SMTP_HOST: "mail.supernovatel.com"
      SMTP_PORT: 465
      SMTP_SECURE: "true"
      SMTP_USER: "saas@supernovatel.com"
      SMTP_PASS: "if5u/WD9kZ"
      SMTP_FROM: "PharmaFlow <saas@supernovatel.com>"
      WEB_ORIGIN: "https://farmasnt.supernovatel.com"

      # Object storage (S3 / MinIO)
      # NOTE: These are required for product photo upload and tenant logo upload.
      # Recommend setting them via server env / .env (not hardcoding secrets here).
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID:-}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY:-}
      # Must be browser-reachable (usually via nginx), e.g. https://assets.example.com/<bucket>
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-}
      # MinIO typically requires path-style URLs
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      # Prisma: si una migración quedó marcada como FAILED (P3009), el contenedor no podrá aplicar nuevas.
      # Para este caso puntual (20260116063727_pagos) habilitamos una resolución automática y reintento.
      # IMPORTANTE: si la migración alcanzó a aplicar cambios parcialmente, puede requerir limpieza manual.
      PRISMA_MIGRATE_RESOLVE_ON_FAIL: "1"
      PRISMA_MIGRATE_RESOLVE_ACTION: "rolled-back"
      PRISMA_MIGRATE_RESOLVE_NAMES: "20260116063727_pagos"
    ports:
      - "6000:6000"  # Mantener puerto 6000 para acceso interno
    networks:
      - red-interna

  frontend-farmasnt:
    build:
      context: ./frontend
      args:
        # Importante: VITE_* se inyecta en build (no en runtime)
        VITE_API_BASE_URL: "https://farmasnt.supernovatel.com"  # Mantener URL absoluta para evitar problemas SSL
        VITE_BACKEND_TARGET: "http://backend-farmasnt:6000"
    container_name: frontend-farmasnt
    restart: always
    environment:
      # Vite preview (runtime) bloquea hosts no permitidos; al entrar por IP externa
      # puede quedar en blanco si el host no está en allowedHosts.
      VITE_ALLOW_ALL_HOSTS: "1"
    depends_on:
      - backend-farmasnt
    ports:
      - "6001:6001"
    networks:
      - red-interna

networks:
  red-interna:
    name: red-interna
    external: true
